map $http_accept $format {
  default json;
  text/csv csv;
  application/json json;
}

server {
  absolute_redirect off;
  listen 80;
  default_type application/json;

  root public;

  index openapi.json;

  # Remove trailing slashes
  rewrite ^/(.*)/$ /$1 permanent;
  # Records content negotiation
  location @recordscontentnegotiation {
    rewrite ^/records/([A-Za-z\d][A-Za-z\d-_.\/]*)$ /records/$1.$format break;
  }

  # Records
  location /records {
    rewrite ^/records.csv /records/index.csv;
    rewrite ^/records.json /records/index.json;
    rewrite ^/records$ /records/index.$format break;
    try_files $uri @recordscontentnegotiation;
  }


  # Entries
  location /entries {
    # Entry slices
    if ($arg_start) {
      rewrite ^/entries$ /entries/slices/$arg_start.$format break;
      rewrite ^/entries.csv /entries/slices/$arg_start.csv;
      rewrite ^/entries.json /entries/slices/$arg_start.json;
    }
    rewrite ^/entries$ /entries/index.$format break;
    rewrite ^/entries.csv /entries/index.csv;
    rewrite ^/entries.json /entries/index.json;
    rewrite ^/entries/(\d+)$ /entries/$1.$format break;
  }

  location / {
    # Legacy
    rewrite ^/record/(.*)$ /records/$1 permanent;
    rewrite ^/entry/(.*)$ /entries/$1 permanent;
    rewrite ^/item/(.*)$ /items/$1 permanent;

    # Register
    rewrite ^/register$ /register.json break;

    # Items
    rewrite ^/items.csv /items/index.csv;
    rewrite ^/items.json /items/index.json;
    rewrite ^/items$ /items/index.$format break;
    rewrite ^/items/(\w|:|-)$ /items/$1.$format break;

    # Archive
    rewrite ^/download-register /archive.zip;

    # RSF
    rewrite ^/download-rsf /commands/0.rsf;
    rewrite ^/commands /commands/0.rsf break;
    rewrite ^/download-rsf/(.*)$ /commands/$1.rsf;
  }
}
